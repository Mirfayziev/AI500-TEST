{% extends "base.html" %}
{% block title %}AI Chat{% endblock %}

{% block extra_css %}
<style>
  .ai-shell {
    max-width: 980px;
    margin: 0 auto;
  }

  .ai-card {
    background: var(--white);
    border-radius: 18px;
    box-shadow: var(--shadow);
    overflow: hidden;
    border: 1px solid var(--border);
  }

  .ai-header {
    padding: 16px 18px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    background: linear-gradient(135deg, rgba(0,132,212,0.10) 0%, rgba(30,181,58,0.10) 100%);
    border-bottom: 1px solid var(--border);
  }

  .ai-header .left {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .ai-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid rgba(0,132,212,0.25);
    background: rgba(255,255,255,0.85);
    color: var(--text);
    font-weight: 600;
    font-size: 12px;
  }

  .ai-dot {
    width: 10px;
    height: 10px;
    border-radius: 999px;
    background: #9ca3af;
  }
  .ai-dot.live { background: var(--secondary); }
  .ai-dot.demo { background: #f59e0b; }

  .ai-actions {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .ai-actions .btn {
    padding: 0.6rem 1rem;
    border-radius: 12px;
    font-size: 0.9rem;
  }

  .ai-chat {
    height: calc(100vh - 270px);
    min-height: 420px;
    max-height: 640px;
    overflow: auto;
    padding: 18px;
    background: radial-gradient(circle at top left, rgba(0,132,212,0.06), transparent 50%),
                radial-gradient(circle at bottom right, rgba(30,181,58,0.06), transparent 55%),
                #fbfcfd;
  }

  .msg {
    display: flex;
    gap: 10px;
    margin: 10px 0;
    align-items: flex-start;
  }

  .avatar {
    width: 36px;
    height: 36px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 800;
    flex: 0 0 auto;
  }
  .avatar.user { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); }
  .avatar.ai { background: linear-gradient(135deg, var(--secondary), #129a2a); }

  .bubble {
    max-width: 820px;
    padding: 12px 14px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: white;
    box-shadow: 0 1px 0 rgba(0,0,0,0.03);
    white-space: pre-wrap;
    word-break: break-word;
  }

  .msg.user {
    flex-direction: row-reverse;
  }
  .msg.user .bubble {
    background: rgba(0,132,212,0.08);
    border-color: rgba(0,132,212,0.22);
  }

  .ai-footer {
    padding: 14px;
    border-top: 1px solid var(--border);
    background: white;
  }

  .composer {
    display: flex;
    gap: 10px;
    align-items: flex-end;
  }

  .composer textarea {
    flex: 1;
    min-height: 46px;
    max-height: 180px;
    resize: vertical;
    border: 2px solid var(--border);
    border-radius: 14px;
    padding: 10px 12px;
    font-family: inherit;
    font-size: 0.95rem;
    outline: none;
  }

  .composer textarea:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(0,132,212,0.10);
  }

  .hint {
    margin-top: 10px;
    color: var(--text-light);
    font-size: 12px;
  }

  .typing {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: var(--text-light);
    font-size: 13px;
    padding: 8px 10px;
  }

  .dots {
    display: inline-flex;
    gap: 4px;
    align-items: center;
  }
  .dots span {
    width: 6px;
    height: 6px;
    border-radius: 999px;
    background: #9ca3af;
    animation: bounce 1.1s infinite;
  }
  .dots span:nth-child(2) { animation-delay: 0.15s; }
  .dots span:nth-child(3) { animation-delay: 0.3s; }
  @keyframes bounce {
    0%, 80%, 100% { transform: translateY(0); opacity: 0.55; }
    40% { transform: translateY(-4px); opacity: 1; }
  }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">AI Chat</h1>
  <p class="page-subtitle">ChatGPT kabi suhbat oynasi (OpenAI‑compatible API orqali)</p>
</div>

<div class="ai-shell">
  <div class="ai-card">
    <div class="ai-header">
      <div class="left">
        <div class="ai-badge" id="aiModeBadge">
          <span class="ai-dot demo" id="aiModeDot"></span>
          <span id="aiModeText">Ulanmoqda...</span>
        </div>
        <div class="ai-badge" title="Suhbat lokal saqlanadi (brauzerda)">
          <i class="fas fa-database"></i>
          Local history
        </div>
      </div>
      <div class="ai-actions">
        <button class="btn btn-outline" id="btnClear" type="button">
          <i class="fas fa-trash"></i> Tozalash
        </button>
      </div>
    </div>

    <div class="ai-chat" id="chatBox" aria-live="polite"></div>

    <div class="ai-footer">
      <div class="composer">
        <textarea id="prompt" placeholder="Savolingizni yozing... (Enter = yuborish, Shift+Enter = yangi qator)"></textarea>
        <button class="btn btn-primary" id="btnSend" type="button">
          <i class="fas fa-paper-plane"></i> Yuborish
        </button>
      </div>
      <div class="hint">
        Maslahat: agar serverda <code>AI_API_KEY</code> sozlanmagan bo‘lsa, demo rejim javob beradi.
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const STORAGE_KEY = "af_ai_chat_history_v1";
  const chatBox = document.getElementById("chatBox");
  const promptEl = document.getElementById("prompt");
  const btnSend = document.getElementById("btnSend");
  const btnClear = document.getElementById("btnClear");

  const aiModeText = document.getElementById("aiModeText");
  const aiModeDot = document.getElementById("aiModeDot");

  /** @type {{role: "user"|"assistant", content: string}[]} */
  let messages = [];
  let isSending = false;

  function escapeHtml(s) {
    return (s || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function scrollToBottom() {
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function renderMessage(role, content) {
    const msg = document.createElement("div");
    msg.className = "msg " + role;

    const avatar = document.createElement("div");
    avatar.className = "avatar " + (role === "user" ? "user" : "ai");
    avatar.textContent = role === "user" ? "{{ current_user.full_name[0] }}" : "AI";

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.innerHTML = escapeHtml(content);

    msg.appendChild(avatar);
    msg.appendChild(bubble);
    chatBox.appendChild(msg);
    scrollToBottom();
  }

  function renderTyping(on) {
    const id = "typingRow";
    const existing = document.getElementById(id);
    if (!on) {
      if (existing) existing.remove();
      return;
    }
    if (existing) return;

    const row = document.createElement("div");
    row.id = id;
    row.className = "typing";
    row.innerHTML = '<span>AI yozmoqda</span><span class="dots"><span></span><span></span><span></span></span>';
    chatBox.appendChild(row);
    scrollToBottom();
  }

  function setMode(mode, model) {
    if (mode === "live") {
      aiModeDot.classList.remove("demo");
      aiModeDot.classList.add("live");
      aiModeText.textContent = "Live: " + (model || "model");
      return;
    }
    aiModeDot.classList.remove("live");
    aiModeDot.classList.add("demo");
    aiModeText.textContent = "Demo rejim";
  }

  function save() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(messages.slice(-40)));
    } catch (_) {}
  }

  function load() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) return;
      messages = parsed.filter(m => m && (m.role === "user" || m.role === "assistant") && typeof m.content === "string");
      messages.forEach(m => renderMessage(m.role, m.content));
    } catch (_) {}
  }

  async function send() {
    if (isSending) return;
    const text = (promptEl.value || "").trim();
    if (!text) return;

    isSending = true;
    btnSend.disabled = true;
    promptEl.disabled = true;

    promptEl.value = "";
    messages.push({ role: "user", content: text });
    renderMessage("user", text);
    save();

    renderTyping(true);

    try {
      const res = await fetch("/api/ai/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages: messages.slice(-20) })
      });

      const data = await res.json().catch(() => ({}));
      renderTyping(false);

      if (!res.ok) {
        const err = data && data.error ? data.error : ("Server xatosi (" + res.status + ")");
        renderMessage("assistant", "Xato: " + err);
        messages.push({ role: "assistant", content: "Xato: " + err });
        save();
        return;
      }

      setMode(data.mode, data.model);
      const answer = (data && data.message) ? String(data.message) : "";
      renderMessage("assistant", answer || "(bo‘sh javob)");
      messages.push({ role: "assistant", content: answer || "(bo‘sh javob)" });
      save();
    } catch (e) {
      renderTyping(false);
      const msg = "Ulanish xatosi: " + (e && e.message ? e.message : "noma’lum");
      renderMessage("assistant", msg);
      messages.push({ role: "assistant", content: msg });
      save();
    } finally {
      isSending = false;
      btnSend.disabled = false;
      promptEl.disabled = false;
      promptEl.focus();
    }
  }

  btnSend.addEventListener("click", send);
  btnClear.addEventListener("click", () => {
    messages = [];
    localStorage.removeItem(STORAGE_KEY);
    chatBox.innerHTML = "";
    setMode("demo");
    promptEl.focus();
  });

  promptEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      send();
    }
  });

  // Initial
  load();
  setMode("demo");
  promptEl.focus();
</script>
{% endblock %}

